# WebRTC通信経路の分析

このドキュメントでは、LiveKit Agent PlaygroundにおけるWebRTC通信の仕組みと、実際のログから分析した通信経路について説明します。
※ネットワーク制限のないEC2で検証した内容

## 環境構成

```
[ローカルPC] → NAT/ルーター → インターネット → [AWS EC2]
     ↓                                               ↓
localhost:3000                          LiveKitサーバー:7880-7882
(ポートフォワード)                      (3.113.14.140 - 東京リージョン)
```

- **LiveKitサーバー**: EC2上で実行
- **Webクライアント**: EC2上で実行し、localhostにポートフォワーディング
- **実際の通信**: localhost(自PC) → LiveKitサーバー(EC2)にWebRTC通信

## WebRTC通信経路の詳細

### 1. ICE候補の種類と優先順位

LiveKitサーバーのログから確認できたICE候補：

```
- host候補（最優先）: 10.0.34.253:7882 (UDP)
- srflx候補（STUN経由）: 3.113.14.140（複数ポート: 52313, 60210, 45353）
- TCP候補（フォールバック）: 10.0.34.253:7881
```

### 2. 実際の通信フロー

1. **ローカルネットワーク内通信**（同一ネットワークの場合）
   - WebClient → 10.0.34.253:7882 (UDP) → LiveKitサーバー
   - プライベートIP（10.0.x.x）を使用した直接通信

2. **STUNサーバー経由**（異なるネットワーク間の通信 - 実際に使用）
   - WebClient → 3.113.14.140（AWS東京リージョン）→ LiveKitサーバー
   - Server Reflexive (srflx)候補を使用
   - NATトラバーサルが成功

3. **TCPフォールバック**（UDP通信が不可の場合）
   - WebClient → 10.0.34.253:7881 (TCP) → LiveKitサーバー

### 3. メディアストリームの詳細

ログから確認できた通信品質：

```
- コーデック: Opus (48kHz, 2ch) + RED（冗長エンコーディング）
- ビットレート: 約58kbps
- パケットロス: 0%（良好な接続）
- ジッター: 51.29ms（許容範囲内）
- 最大ジッター: 82.50ms
```

### 4. セッション管理

- **DataChannel（SCTP）**: シグナリング用
- **Audio Track（RTP/SAVPF）**: 音声データ転送用
- **DTLS暗号化**: 通信の保護

## NATトラバーサルの仕組み

### STUNの動作

1. **STUN候補の確認**
   ```
   a=candidate:1265259072 1 udp 1694498815 3.113.14.140 52313 typ srflx raddr 0.0.0.0 rport 52313
   ```
   - `typ srflx` = Server Reflexive候補（STUNで発見）
   - `3.113.14.140` = パブリックIPアドレス

2. **NATトラバーサルのプロセス**
   ```
   1. 自PC → STUNサーバー: "私のパブリックIPは？"
   2. STUN → 自PC: "あなたは xxx.xxx.xxx.xxx:yyyyy です"
   3. 自PC → EC2: UDP hole punchingで直接通信開始
   4. EC2 → 自PC: パブリックIPなので直接返信可能
   ```

### TURNが不要な理由

1. **現在のネットワーク構成の特徴**
   - 自PC側: 一般的な家庭/オフィスNAT（制限なし）
   - EC2側: パブリックIP直接割り当て（NATなし）

2. **STUNで十分な条件**
   - EC2がパブリックIPを持つ（3.113.14.140）
   - 片側のみNAT（自PC側のみ）
   - ファイアウォールが寛容（UDP:7882が開放）

3. **ログからの判断根拠**
   ```
   ✓ srflx候補の存在 → STUNが動作している
   ✗ relay候補の不在 → TURNは使われていない
   ✓ パケットロス0% → 直接通信が成功している
   ```

## TURNが必要になるケース

以下のような環境では、TURNリレーサーバーが必要になります：

- 対称型NAT × 対称型NAT
- 厳格なファイアウォール（UDP完全ブロック）
- 企業の制限的なプロキシ環境
- 両端末がNATの背後にある場合

## 使用ポート一覧

| ポート | プロトコル | 用途 |
|--------|------------|------|
| 3000 | TCP | Webクライアント（Vite開発サーバー） |
| 7880 | TCP/WS | LiveKit WebSocket（シグナリング） |
| 7881 | TCP | Turn/STUN（TCPフォールバック） |
| 7882 | UDP | WebRTC メディア転送 |

## EC2から自PCへの音声データ送信の仕組み

### ICEネゴシエーションによる双方向の情報交換

1. **自PC → EC2**: "私の候補アドレスはこれらです"
   - ローカルIP: 192.168.x.x:xxxxx
   - パブリックIP: xxx.xxx.xxx.xxx:52313 (STUNで取得)

2. **EC2 → 自PC**: "私の候補アドレスはこれらです"
   - ローカルIP: 10.0.34.253:7882
   - パブリックIP: 3.113.14.140:7882

### UDP Hole Punchingの仕組み

```
[自PC]                    [NAT/ルーター]              [EC2]
  |                           |                         |
  |---UDP送信(src:内部IP)---->|---変換(src:公開IP)----->|
  |                           | ★ポートマッピング記憶  |
  |                           |                         |
  |<--UDP返信(dst:公開IP)-----|<--逆変換(dst:内部IP)---|
```

### 実際の通信確立プロセス

1. **自PC → EC2への最初のパケット送信**
   - 送信元: 192.168.1.100:54321 (内部)
   - NAT変換: xxx.xxx.xxx.xxx:52313 (外部)
   - 送信先: 3.113.14.140:7882

2. **NATのマッピングテーブル**
   ```
   内部: 192.168.1.100:54321 ⟷ 外部: xxx.xxx.xxx.xxx:52313
   ```

3. **EC2からの返信**
   - 送信元: 3.113.14.140:7882
   - 送信先: xxx.xxx.xxx.xxx:52313 (STUNで知った自PCの公開IP)
   - NAT逆変換: 192.168.1.100:54321へ配送

### なぜこれが機能するのか

- **双方向性**: 自PCから先にパケットを送ることでNATに穴を開ける
- **ステートフル**: NATは確立された接続を記憶し、返信を適切にルーティング
- **タイムアウト防止**: 定期的なキープアライブでNATセッションを維持

重要な点：EC2は自PCの内部IPを知る必要はなく、STUNで発見された公開IP:ポートに送信すれば、NATが自動的に内部IPへ転送します。

## まとめ

現在の構成では、EC2がパブリックIPを持ち、自PC側のNATが一般的なタイプであるため、STUNによるNATトラバーサルだけで十分です。TURNリレーは不要で、効率的な直接通信が実現されています。

パケットロス0%、適切なジッター値など、良好な通信品質が確保されており、リアルタイム音声通信に適した環境が構築されています。